# BotEngine
Движок команд и кастомных обработчиков команд.

## Конструктор
Принимает единственный параметр `bool $needLowerCase`, от которого зависит, нужно ли использовать функцию `mb_strtolower` при обработке команд или нет. По умолчанию `true`.

```php
/* First way */
$vk = new vk('lp');
$be = $vk->bot;

/* Second way */
$be = new BotEngine();
```

## onCommands
Создание команд.

| Параметр | Тип      | Описание                   |
|----------|----------|----------------------------|
| $names   | array    | Массив с названиями команд |
| $handler | callable | Функция-обработчик         |

Функция `$handler` будет вызвана, когда одно из слов, указанных в `$names`, окажется первым в сообщении. Она принимает аргументы `$data` (информация о сообщении, ассоциативный массив или просто массив) и `$msg` ([Message](message.md)).

Вы можете задать обработчик неизвестной команды, указав в `$names` значение `default`.

```php
// Сработает при text = 'test' || 'тест' | 'тест команда 123 213'
$be->onCommands(['test', 'тест'], function($data, $msg) {
	$msg->reply('Ответ на тестовую команду');
});

// Ответ на любую неизвестную команду
$vk->bot->onCommands(['default'], function($data, $msg) {
	$msg->reply('Ответ на неизвестную команду');
});
```

## onPayload
Создание payload-команд. Эти команды обрабатываются на основе `payload` сообщения.

| Параметр | Тип      | Описание                   |
|----------|----------|----------------------------|
| $names   | array    | Массив с названиями команд |
| $handler | callable | Функция-обработчик         |

Функция `$handler` принимает аргументы `$data` (информация о сообщении, ассоциативный массив или просто массив) и `$msg` ([Message](message.md)). Она будет вызвана, если поле `command` в `payload` сообщения будет равно одной из строк в `$names`.

```php
/**
 * Если юзер нажмёт на кнопку, payload которой будет равен
 * {"command":"start"} или {"command":"menu"}
 * сработает $handler
 */
$be->onPayload(['start', 'menu'], function($data, $msg) {
	$msg->reply('Главное меню');
});
```

## hear
Универсальный конструктор команд. Под капотом используются `onCommands` и `onPayload`.

| Параметр    | Тип      | Описание                                                   |
|-------------|----------|------------------------------------------------------------|
| $names      | array    | Массив с названиями команд                                 |
| $handler    | callable | Функция-обработчик                                         |
| $is_payload | bool     | Добавить payload-команду или обычную. По умолчанию `false` |

```php
$be->hear(['default'], function($data, $msg) {
	$msg->send('Неизвестная команда');
});

$be->hear(['payloadtest'], function($data, $msg) {
	$msg->send('Тестовая payload-команда');
}, true);
```

## Команды и регулярные выражения
> Это **нестабильная** фича.

Вы можете добавлять команды, которые будут определяться с помощью регулярных выражений (regexp). Поддерживается во всех методах: `onCommands`, `onPayload` и `hear`.

Появляется третье значение, передаваемое в функцию-обработчик — `$match`. Оно содержит в себе результат использования регулярного выражения. Это поле есть всегда, но вы можете его не обрабатывать.

Если вы используете обычные команды (не на регулярках), под капотом они всё равно будут приведены к виду `/^{COMMAND}$/i`, поэтому лучше использовать регулярки.

```php
/**
 * Сработает при
 * text = PiNg qwerty
 * 
 * Не сработает при
 * text = ping
 */
$be->hear(['/^ping (.*)/i'], function($data, $msg, $match) {
  $msg->send("Pong! Вы ввели этот текст: {$match[1]}");
});

/**
 * Сработает при
 * text = ping
 * 
 * Не сработает при
 * text = ping sdfg
 * или
 * text = dlgjdfgping
 * 
 * Поэтому рекомендуется использовать регулярки
 */
$be->hear(['ping'], function($data, $msg) {
  $msg->send('Pong!');
});
```

## registerAlias
Создать алиас для команды.

| Параметр     | Тип    | Описание                 |
|--------------|--------|--------------------------|
| $payloadName | string | Название payload-команды |
| $textName    | string | Название обычной команды |

```php
/**
 * Сообщение, где text = 'начать' (или 'НаЧаТь', если вы включили независимость от регистра)
 * будет эквивалентно сообщению, где
 * payload = '{"command":"start"}'
 * и наоборот.
 */
$be->registerAlias('start', 'начать');
```

## on
Добавить новый обработчик события.

| Параметр | Тип      | Описание                               |
|----------|----------|----------------------------------------|
| $name    | string   | Название события или его код в User LP |
| $handler | callable | Функция-обработчик                     |

```php
// Callback API и Bots Longpoll
$be->on('group_leave', function($data) {
	echo "-1 саб";
});

// User Longpoll
$be->on('9', function($data) {
	echo "кто-то вышел из сети";
});
```

### Блокировка проверки команд
Вы можете заблокировать проверку команд с помощью кастомного обработчика события `message_new` или `4`, который вернёт `false`.

```php
// Если пользователь, то 4 событие. Если сообщество, то message_new
$event = $config['type'] === 'user' ? '4' : 'message_new';

$be->on($event, function($data) {
	if($data['object']['message']['peer_id'] == 1) {
		// Если сообщение из peer_id = 1, блокируем проверку команд
		return false;
	}

	// Мы не хотим блокировать проверку команд. Возвращаем true

	return true;
});
```